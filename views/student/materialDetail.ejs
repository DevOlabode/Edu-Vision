<% layout('layout/boilerplate.ejs') %>

<div class="container mt-5">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h3><%= material.title %></h3>
        </div>
        <div class="card-body">
          <!-- File Information Header -->
          <div class="file-info-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; padding: 25px; margin-bottom: 30px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <div class="row align-items-center">
              <div class="col-lg-8">
                <div class="file-details-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                  <!-- File Name -->
                  <div class="file-detail-item" style="background: white; padding: 15px 20px; border-radius: 10px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);">
                    <div class="d-flex align-items-center">
                      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <i class="fas fa-file-alt" style="font-size: 16px;"></i>
                      </div>
                      <div>
                        <small style="color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 11px;">File Name</small>
                        <div style="font-weight: 700; color: #2c3e50; font-size: 14px; margin-top: 2px;"><%= material.fileName %></div>
                      </div>
                    </div>
                  </div>

                  <!-- File Type -->
                  <div class="file-detail-item" style="background: white; padding: 15px 20px; border-radius: 10px; border-left: 4px solid #f093fb; box-shadow: 0 2px 8px rgba(240, 147, 251, 0.1);">
                    <div class="d-flex align-items-center">
                      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">
                        <i class="fas fa-file-<%= material.fileType === 'pdf' ? 'pdf' : material.fileType === 'docx' ? 'word' : 'alt' %>" style="font-size: 16px;"></i>
                      </div>
                      <div>
                        <small style="color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 11px;">File Type</small>
                        <div style="font-weight: 700; color: #2c3e50; font-size: 14px; margin-top: 2px;"><%= material.fileType.toUpperCase() %></div>
                      </div>
                    </div>
                  </div>

                  <!-- File Size -->
                  <div class="file-detail-item" style="background: white; padding: 15px 20px; border-radius: 10px; border-left: 4px solid #28a745; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);">
                    <div class="d-flex align-items-center">
                      <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
                        <i class="fas fa-weight-hanging" style="font-size: 16px;"></i>
                      </div>
                      <div>
                        <small style="color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 11px;">File Size</small>
                        <div style="font-weight: 700; color: #2c3e50; font-size: 14px; margin-top: 2px;"><%= (material.fileSize / 1024).toFixed(2) %> KB</div>
                      </div>
                    </div>
                  </div>

                  <!-- Status -->
                  <div class="file-detail-item" style="background: white; padding: 15px 20px; border-radius: 10px; border-left: 4px solid <%= material.status === 'ready' ? '#28a745' : material.status === 'processing' ? '#ffc107' : '#dc3545' %>; box-shadow: 0 2px 8px <%= material.status === 'ready' ? 'rgba(40, 167, 69, 0.1)' : material.status === 'processing' ? 'rgba(255, 193, 7, 0.1)' : 'rgba(220, 53, 69, 0.1)' %>;">
                    <div class="d-flex align-items-center">
                      <div style="background: linear-gradient(135deg, <%= material.status === 'ready' ? '#28a745 0%, #20c997 100%' : material.status === 'processing' ? '#ffc107 0%, #fd7e14 100%' : '#dc3545 0%, #e83e8c 100%' %>); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 12px <%= material.status === 'ready' ? 'rgba(40, 167, 69, 0.3)' : material.status === 'processing' ? 'rgba(255, 193, 7, 0.3)' : 'rgba(220, 53, 69, 0.3)' %>;">
                        <i class="fas fa-<%= material.status === 'ready' ? 'check-circle' : material.status === 'processing' ? 'clock' : 'exclamation-triangle' %>" style="font-size: 16px;"></i>
                      </div>
                      <div>
                        <small style="color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 11px;">Status</small>
                        <div style="font-weight: 700; color: #2c3e50; font-size: 14px; margin-top: 2px; text-transform: capitalize;"><%= material.status %></div>
                      </div>
                    </div>
                  </div>

                  <!-- Upload Date -->
                  <div class="file-detail-item" style="background: white; padding: 15px 20px; border-radius: 10px; border-left: 4px solid #6c757d; box-shadow: 0 2px 8px rgba(108, 117, 125, 0.1);">
                    <div class="d-flex align-items-center">
                      <div style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);">
                        <i class="fas fa-calendar-alt" style="font-size: 16px;"></i>
                      </div>
                      <div>
                        <small style="color: #6c757d; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 11px;">Uploaded</small>
                        <div style="font-weight: 700; color: #2c3e50; font-size: 14px; margin-top: 2px;"><%= new Date(material.createdAt).toLocaleDateString() %></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="col-lg-4">
                <div class="action-buttons" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); height: fit-content;">
                  <div class="text-center">
                    <h6 style="color: #2c3e50; font-weight: 700; margin-bottom: 20px; font-size: 16px;">Actions</h6>
                    <form action="/materials/<%= material._id %>?_method=DELETE" method="POST" class="d-inline">
                      <button type="submit" class="btn btn-danger btn-lg px-4 py-2" onclick="return confirm('Are you sure you want to delete this material?')" style="border-radius: 25px; font-weight: 600; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3); transition: all 0.3s ease;">
                        <i class="fas fa-trash-alt me-2"></i>Delete Material
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <% if (material.summary) { %>
            <hr style="border: 0; height: 2px; background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #f5576c); border-radius: 2px; margin: 40px 0;">
            <div class="mt-4">
              <!-- AI Summary Header -->
              <div class="text-center mb-5">
                <div class="ai-summary-header" style="display: inline-block; padding: 20px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); border-radius: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); color: white;">
                  <h3 class="mb-2" style="font-weight: 700; font-size: 2.2rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    <i class="fas fa-brain me-3"></i>AI Study Assistant
                  </h3>
                  <p class="mb-0" style="font-size: 1.1rem; opacity: 0.9;">Smart summaries & flashcards generated for you</p>
                </div>
              </div>

              <!-- Study Notes Section -->
              <% if (material.studyNotes) { %>
                <div class="study-notes-section mb-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                  <h4 class="mb-4" style="color: #495057; font-weight: 700; font-size: 1.5rem; margin-bottom: 25px; display: flex; align-items: center;">
                    <i class="fas fa-book-open" style="color: #6c757d; margin-right: 12px; font-size: 1.3rem;"></i>
                    Study Notes
                  </h4>
                  <div class="study-notes-content" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8; color: #2c3e50; font-size: 16px;">
                    <%
                      // Split the study notes into lines and format them
                      const lines = material.studyNotes.split('\n').filter(line => line.trim());
                      let inList = false;
                      let listType = '';
                      lines.forEach((line, index) => {
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('â€¢ ')) {
                          // Bullet point
                          if (!inList || listType !== 'ul') {
                            if (inList) { %></ol><% }
                            inList = true;
                            listType = 'ul';
                    %>
                      <ul style="margin-bottom: 18px; padding-left: 25px; list-style: none;">
                    <%
                        }
                    %>
                        <li style="margin-bottom: 10px; color: #495057; display: flex; align-items: flex-start; padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#f1f3f4'" onmouseout="this.style.backgroundColor='transparent'">
                          <i class="fas fa-check-circle" style="color: #28a745; margin-right: 10px; margin-top: 2px; font-size: 0.9rem;"></i>
                          <span style="flex-grow: 1; font-weight: 500;"><%= trimmedLine.substring(2) %></span>
                        </li>
                    <%
                      } else if (trimmedLine.match(/^\d+\./)) {
                        // Numbered list
                        const match = trimmedLine.match(/^(\d+)\.\s*(.+)$/);
                        if (match) {
                          if (!inList || listType !== 'ol') {
                            if (inList) { %></ul><% }
                            inList = true;
                            listType = 'ol';
                    %>
                      <ol style="margin-bottom: 18px; padding-left: 25px;">
                    <%
                          }
                    %>
                          <li style="margin-bottom: 10px; color: #495057; padding: 8px 12px; border-radius: 6px; transition: background-color 0.2s ease;" onmouseover="this.style.backgroundColor='#f1f3f4'" onmouseout="this.style.backgroundColor='transparent'">
                            <span style="font-weight: 500;"><%= match[2] %></span>
                          </li>
                    <%
                        }
                      } else {
                        // Close any open list
                        if (inList) {
                          if (listType === 'ul') { %></ul><% } else { %></ol><% }
                          inList = false;
                        }
                        if (trimmedLine.length < 50 && (trimmedLine.includes(':') || trimmedLine.toUpperCase() === trimmedLine)) {
                          // Likely a heading or key term
                    %>
                          <div class="study-heading" style="background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%); color: #495057; padding: 15px 20px; border-radius: 8px; margin-bottom: 15px; margin-top: 25px; font-weight: 700; font-size: 1.2rem; border-left: 4px solid #6c757d; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <i class="fas fa-star" style="color: #ffc107; margin-right: 8px;"></i>
                            <%= trimmedLine %>
                          </div>
                    <%
                        } else {
                          // Regular paragraph
                    %>
                          <div class="study-paragraph" style="background: #ffffff; padding: 15px 20px; border-radius: 8px; margin-bottom: 18px; border: 1px solid #e9ecef; border-left: 4px solid #6c757d; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: box-shadow 0.2s ease;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'">
                            <div style="font-weight: 400; color: #495057; line-height: 1.7;">
                              <%= trimmedLine %>
                            </div>
                          </div>
                    <%
                        }
                      }
                    });
                    // Close any remaining open list
                    if (inList) {
                      if (listType === 'ul') { %></ul><% } else { %></ol><% }
                    }
                  %>
                  </div>
                </div>
              <% } %>

              <!-- Flashcards Section -->
              <% if (material.flashcards && material.flashcards.length > 0) { %>
                <div class="card shadow-lg border-0" style="border-radius: 20px; overflow: hidden; background: linear-gradient(145deg, #ffffff 0%, #fff5f8 100%);">
                  <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 25px 30px; cursor: pointer; transition: all 0.3s ease;" data-bs-toggle="collapse" data-bs-target="#flashcardsCollapse" aria-expanded="false" aria-controls="flashcardsCollapse">
                    <div style="position: absolute; top: -10px; right: -10px; width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-brain" style="font-size: 24px;"></i>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h5 class="mb-1" style="font-weight: 700; font-size: 1.4rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                          ðŸ§  Flashcards
                        </h5>
                        <p class="mb-0 opacity-75" style="font-size: 0.95rem;">Test your knowledge with these cards</p>
                      </div>
                      <div class="text-end">
                        <span class="badge" style="background: rgba(255,255,255,0.25); color: white; font-size: 0.9rem; padding: 8px 15px; border-radius: 20px; font-weight: 600;">
                          <%= material.flashcards.length %> cards
                        </span>
                        <i class="fas fa-chevron-down ms-3 transition-transform" style="font-size: 1.2rem;"></i>
                      </div>
                    </div>
                  </div>
                  <div id="flashcardsCollapse" class="collapse">
                    <div class="card-body" style="padding: 30px;">
                      <div class="flashcards-container">
                        <% material.flashcards.forEach((card, index) => { %>
                          <div class="flashcard-item mb-4" style="background: linear-gradient(135deg, #ffffff 0%, #fef7ff 100%); border: 2px solid #f093fb; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(240, 147, 251, 0.15); transition: all 0.3s ease;">
                            <!-- Question Header -->
                            <div class="flashcard-question" style="padding: 20px 25px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; cursor: pointer; display: flex; align-items: center; justify-content: space-between;" data-bs-toggle="collapse" data-bs-target="#answer-<%= index %>" aria-expanded="false" aria-controls="answer-<%= index %>">
                              <div class="d-flex align-items-center">
                                <div style="background: rgba(255,255,255,0.2); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; margin-right: 15px;">
                                  <%= index + 1 %>
                                </div>
                                <div class="question-text" style="font-weight: 600; font-size: 16px; flex-grow: 1;">
                                  <%= card.question %>
                                </div>
                              </div>
                              <i class="fas fa-chevron-down transition-transform" style="font-size: 1.2rem; transition: transform 0.3s ease;"></i>
                            </div>

                            <!-- Answer Content -->
                            <div id="answer-<%= index %>" class="collapse">
                              <div class="flashcard-answer" style="padding: 30px; background: linear-gradient(135deg, #fef7ff 0%, #fdf2ff 100%); border-top: 2px solid #f093fb; position: relative; overflow: hidden;">
                                <!-- Close button -->
                                <button type="button" class="btn-close position-absolute" style="top: 15px; right: 15px; z-index: 2;" aria-label="Close" onclick="document.getElementById('answer-<%= index %>').classList.remove('show');">
                                  <span aria-hidden="true" style="color: #f5576c; font-size: 20px;">&times;</span>
                                </button>

                                <!-- Decorative element -->
                                <div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: radial-gradient(circle, rgba(240, 147, 251, 0.1) 0%, transparent 70%); border-radius: 50%; transform: translate(40px, -40px);"></div>

                                <div class="answer-content" style="position: relative; z-index: 1;">
                                  <!-- Answer label with icon -->
                                  <div class="d-flex align-items-center mb-3">
                                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">
                                      <i class="fas fa-lightbulb" style="font-size: 14px;"></i>
                                    </div>
                                    <strong style="color: #f5576c; font-size: 16px; font-weight: 700; text-shadow: 1px 1px 2px rgba(245, 87, 108, 0.2);">Answer</strong>
                                  </div>

                                  <!-- Answer text -->
                                  <div style="white-space: pre-wrap; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.8; color: #2c3e50; font-size: 16px; background: rgba(255,255,255,0.7); padding: 20px; border-radius: 12px; border: 1px solid rgba(240, 147, 251, 0.2); box-shadow: inset 0 2px 8px rgba(0,0,0,0.05);">
                                    <%= card.answer || 'No answer available' %>
                                  </div>

                                  <!-- Encouragement note -->
                                  <div class="text-center mt-3">
                                    <small style="color: #6c757d; font-style: italic;">Great job! Keep studying to master this concept.</small>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% }); %>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>
