<% layout('layout/boilerplate.ejs') %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg" style="border-radius: 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body p-5">
          <h1 class="display-4 font-weight-bold mb-3">Edit Goal</h1>
          <p class="lead opacity-75">Update your goal details and let AI refine your plan!</p>
        </div>
      </div>

      <div class="card shadow mt-4" style="border-radius: 15px; border: none; background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);">
        <div class="card-body p-4">
          <form action="/goals/<%= goal._id %>?_method=PUT" method="POST" id="goalForm" data-milestone-count="<%= goal.milestones ? goal.milestones.length : 0 %>">
            <!-- Goal Title -->
            <div class="mb-4">
              <label for="title" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-bullseye text-primary me-2"></i>Goal Title
              </label>
              <input type="text" class="form-control form-control-lg" id="title" name="title" value="<%= goal.title %>" required
                     placeholder="Enter your goal title" style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>

            <!-- Category -->
            <div class="mb-4">
              <label for="category" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-tags text-primary me-2"></i>Category
              </label>
              <select class="form-select form-select-lg" id="category" name="category" required
                      style="border-radius: 10px; border: 2px solid #e9ecef;">
                <option value="Academic" <%= goal.category === 'Academic' ? 'selected' : '' %>>Academic</option>
                <option value="Personal" <%= goal.category === 'Personal' ? 'selected' : '' %>>Personal</option>
                <option value="Career" <%= goal.category === 'Career' ? 'selected' : '' %>>Career</option>
                <option value="Health" <%= goal.category === 'Health' ? 'selected' : '' %>>Health</option>
                <option value="Other" <%= goal.category === 'Other' ? 'selected' : '' %>>Other</option>
              </select>
            </div>

            <!-- Description -->
            <div class="mb-4">
              <label for="description" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-align-left text-primary me-2"></i>Description
              </label>
              <textarea class="form-control" id="description" name="description" rows="4" required
                        placeholder="Describe your goal in detail..." style="border-radius: 10px; border: 2px solid #e9ecef;"><%= goal.description %></textarea>
            </div>

            <!-- Target Date -->
            <div class="mb-4">
              <label for="targetDate" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-calendar-alt text-primary me-2"></i>Target Date
              </label>
              <input type="date" class="form-control form-control-lg" id="targetDate" name="targetDate" value="<%= goal.targetDate.toISOString().split('T')[0] %>" required
                     style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>

            <!-- Motivation -->
            <div class="mb-4">
              <label for="motivation" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-fire text-primary me-2"></i>Motivation
              </label>
              <textarea class="form-control" id="motivation" name="motivation" rows="3"
                        placeholder="What motivates you to achieve this goal?" style="border-radius: 10px; border: 2px solid #e9ecef;"><%= goal.motivation || '' %></textarea>
            </div>

            <!-- Progress -->
            <div class="mb-4">
              <label for="progress" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-chart-line text-primary me-2"></i>Progress (%)
              </label>
              <input type="number" class="form-control form-control-lg" id="progress" name="progress" min="0" max="100" value="<%= goal.progress || 0 %>"
                     style="border-radius: 10px; border: 2px solid #e9ecef;">
            </div>

            <!-- Status -->
            <div class="mb-4">
              <label for="status" class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-info-circle text-primary me-2"></i>Status
              </label>
              <select class="form-select form-select-lg" id="status" name="status"
                      style="border-radius: 10px; border: 2px solid #e9ecef;">
                <option value="not-started" <%= goal.status === 'not-started' ? 'selected' : '' %>>Not Started</option>
                <option value="in-progress" <%= goal.status === 'in-progress' ? 'selected' : '' %>>In Progress</option>
                <option value="completed" <%= goal.status === 'completed' ? 'selected' : '' %>>Completed</option>
                <option value="abandoned" <%= goal.status === 'abandoned' ? 'selected' : '' %>>Abandoned</option>
              </select>
            </div>

            <!-- Milestones -->
            <div class="mb-4">
              <label class="form-label fw-bold" style="color: #2c3e50; font-size: 1.1rem;">
                <i class="fas fa-flag text-primary me-2"></i>Milestones
              </label>
              <div id="milestonesContainer">
                <% if (goal.milestones && goal.milestones.length > 0) { %>
                  <% goal.milestones.forEach(function(ms, idx) { %>
                    <div class="milestone-item card mb-3" style="border-radius: 10px; border: 1px solid #e9ecef;">
                      <div class="card-body p-3">
                        <div class="row g-3">
                          <div class="col-md-7">
                            <input type="text" class="form-control" name="milestones[<%= idx %>][title]" value="<%= ms.title %>" required
                                   style="border-radius: 8px;">
                          </div>
                          <div class="col-md-4">
                            <input type="date" class="form-control" name="milestones[<%= idx %>][dueDate]" value="<%= ms.dueDate ? ms.dueDate.toISOString().split('T')[0] : '' %>" required
                                   style="border-radius: 8px;">
                          </div>
                          <div class="col-md-1">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeMilestone(this)" style="border-radius: 8px;">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% }); %>
                <% } %>
              </div>
              <button type="button" class="btn btn-outline-primary mt-3" id="addMilestoneBtn" style="border-radius: 20px;">
                <i class="fas fa-plus me-2"></i>Add Milestone
              </button>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-3 mt-5">
              <button type="submit" class="btn btn-primary btn-lg d-flex align-items-center justify-content-center"
                      style="border-radius: 25px; padding: 15px; transition: all 0.3s ease; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <i class="fas fa-save me-2"></i>Update Goal
              </button>
              <a href="/goals/<%= goal._id %>" class="btn btn-outline-secondary btn-lg d-flex align-items-center justify-content-center"
                 style="border-radius: 25px; padding: 15px; transition: all 0.3s ease;">
                <i class="fas fa-arrow-left me-2"></i>Back to Goal
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const initialMilestoneCount = <%- goal.milestones ? goal.milestones.length : 0 %>;
let milestoneCount = initialMilestoneCount;

document.getElementById('addMilestoneBtn').addEventListener('click', function() {
  addMilestone();
});

function addMilestone(title = '', dueDate = '') {
  milestoneCount++;
  const container = document.getElementById('milestonesContainer');

  const milestoneDiv = document.createElement('div');
  milestoneDiv.className = 'milestone-item card mb-3';
  milestoneDiv.style.borderRadius = '10px';
  milestoneDiv.style.border = '1px solid #e9ecef';

  milestoneDiv.innerHTML = `
    <div class="card-body p-3">
      <div class="row g-3">
        <div class="col-md-7">
          <input type="text" class="form-control" name="milestones[${milestoneCount}][title]" placeholder="Milestone title" value="${title}" required
                 style="border-radius: 8px;">
        </div>
        <div class="col-md-4">
          <input type="date" class="form-control" name="milestones[${milestoneCount}][dueDate]" value="${dueDate}" required
                 style="border-radius: 8px;">
        </div>
        <div class="col-md-1">
          <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeMilestone(this)" style="border-radius: 8px;">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  `;

  container.appendChild(milestoneDiv);
}

function removeMilestone(button) {
  button.closest('.milestone-item').remove();
}

// Form validation
document.getElementById('goalForm').addEventListener('submit', function(e) {
  const targetDate = new Date(document.getElementById('targetDate').value);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  if (targetDate < today) {
    e.preventDefault();
    alert('Target date cannot be in the past.');
    return;
  }

  // Show loading state
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating Goal...';
});
</script>

<style>
.form-control:focus, .form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn:hover {
  transform: translateY(-2px);
  transition: transform 0.3s ease;
}

.milestone-item {
  transition: all 0.3s ease;
}

.milestone-item:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1);
}
</style>
