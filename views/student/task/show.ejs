<% layout('layout/boilerplate') %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Task Header Card -->
      <div class="card shadow-lg mb-4" style="border-radius: 20px; border: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body p-5">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h1 class="display-4 font-weight-bold mb-2"><%= task.title %></h1>
              <p class="lead mb-0 opacity-75"><%= task.subject %> â€¢ <%= task.type %></p>
            </div>
            <div class="text-end">
              <span class="badge fs-6 px-3 py-2 mb-2 <%= task.priority === 'high' ? 'bg-danger' : task.priority === 'medium' ? 'bg-warning' : 'bg-success' %>">
                <i class="fas fa-exclamation-triangle me-1"></i><%= task.priority %> Priority
              </span>
              <br>
              <span class="badge fs-6 px-3 py-2 <%= task.status === 'completed' ? 'bg-success' : task.status === 'in-progress' ? 'bg-primary' : task.status === 'overdue' ? 'bg-danger' : 'bg-secondary' %>">
                <%= task.status %>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Task Details -->
        <div class="col-lg-8">
          <div class="card shadow" style="border-radius: 15px; border: none; background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);">
            <div class="card-body p-4">
              <!-- Task Info Grid -->
              <div class="row g-4 mb-4">
                <div class="col-md-6">
                  <div class="info-card p-3 rounded-3" style="background: rgba(102, 126, 234, 0.05); border: 1px solid rgba(102, 126, 234, 0.1);">
                    <div class="d-flex align-items-center mb-2">
                      <i class="fas fa-calendar-alt text-primary me-2"></i>
                      <strong class="text-primary">Due Date</strong>
                    </div>
                    <p class="mb-0 fs-5"><%= new Date(task.dueDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="info-card p-3 rounded-3" style="background: rgba(118, 75, 162, 0.05); border: 1px solid rgba(118, 75, 162, 0.1);">
                    <div class="d-flex align-items-center mb-2">
                      <i class="fas fa-chart-line text-purple me-2"></i>
                      <strong class="text-purple">Difficulty</strong>
                    </div>
                    <p class="mb-0 fs-5"><%= task.difficulty %></p>
                  </div>
                </div>
              </div>

              <% if (task.description) { %>
                <div class="mb-4">
                  <h4 class="mb-3" style="color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-align-left text-primary me-2"></i>Description
                  </h4>
                  <div class="description-box p-3 rounded-3" style="background: #f8f9fa; border-left: 4px solid #667eea;">
                    <p class="mb-0 fs-6"><%= task.description %></p>
                  </div>
                </div>
              <% } %>

              <!-- Planner Info Section -->
              <% if (task.planner) { %>
                <div class="mb-4">
                  <h4 class="mb-3 planner-title" style="color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-brain text-primary me-2"></i>Smart Planner
                  </h4>
                  <div class="card planner-card border-primary" style="border-radius: 15px; background: linear-gradient(145deg, #ffffff 0%, #f0f4ff 100%); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);">
                    <div class="card-body p-4">
                      <% if (task.planner.overview) { %>
                        <div class="planner-section mb-3">
                          <button class="btn btn-link planner-toggle p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#overviewCollapse" aria-expanded="true">
                            <h6 class="text-primary mb-2 d-flex align-items-center">
                              <i class="fas fa-eye me-2 planner-icon"></i>Overview
                              <i class="fas fa-chevron-down ms-auto toggle-icon"></i>
                            </h6>
                          </button>
                          <div class="collapse show" id="overviewCollapse">
                            <div class="planner-content p-3 rounded-3" style="background: rgba(102, 126, 234, 0.05); border-left: 4px solid #667eea;">
                              <p class="mb-0"><%= task.planner.overview %></p>
                            </div>
                          </div>
                        </div>
                      <% } %>
                      <% if (task.planner.suggestedPlan && task.planner.suggestedPlan.length > 0) { %>
                        <div class="planner-section mb-3">
                          <button class="btn btn-link planner-toggle p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#planCollapse" aria-expanded="true">
                            <h6 class="text-primary mb-2 d-flex align-items-center">
                              <i class="fas fa-list-check me-2 planner-icon"></i>Suggested Plan
                              <i class="fas fa-chevron-down ms-auto toggle-icon"></i>
                            </h6>
                          </button>
                          <div class="collapse show" id="planCollapse">
                            <div class="planner-content p-3 rounded-3" style="background: rgba(118, 75, 162, 0.05); border-left: 4px solid #764ba2;">
                              <ul class="list-group list-group-flush">
                                <% task.planner.suggestedPlan.forEach((step, index) => { %>
                                  <li class="list-group-item border-0 px-0 py-2 d-flex align-items-start" style="background: transparent;">
                                    <span class="badge bg-primary me-3 mt-1" style="min-width: 25px; border-radius: 50%;"><%= index + 1 %></span>
                                    <%= step %>
                                  </li>
                                <% }); %>
                              </ul>
                            </div>
                          </div>
                        </div>
                      <% } %>
                      <% if (task.planner.studyTips && task.planner.studyTips.length > 0) { %>
                        <div class="planner-section mb-3">
                          <button class="btn btn-link planner-toggle p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#tipsCollapse" aria-expanded="true">
                            <h6 class="text-primary mb-2 d-flex align-items-center">
                              <i class="fas fa-lightbulb me-2 planner-icon"></i>Study Tips
                              <i class="fas fa-chevron-down ms-auto toggle-icon"></i>
                            </h6>
                          </button>
                          <div class="collapse show" id="tipsCollapse">
                            <div class="planner-content p-3 rounded-3" style="background: rgba(255, 193, 7, 0.05); border-left: 4px solid #ffc107;">
                              <ul class="list-group list-group-flush">
                                <% task.planner.studyTips.forEach((tip, index) => { %>
                                  <li class="list-group-item border-0 px-0 py-2 d-flex align-items-start" style="background: transparent;">
                                    <i class="fas fa-star text-warning me-3 mt-1"></i>
                                    <%= tip %>
                                  </li>
                                <% }); %>
                              </ul>
                            </div>
                          </div>
                        </div>
                      <% } %>
                      <% if (task.planner.estimatedTime) { %>
                        <div class="planner-section mb-3">
                          <button class="btn btn-link planner-toggle p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#timeCollapse" aria-expanded="true">
                            <h6 class="text-primary mb-2 d-flex align-items-center">
                              <i class="fas fa-clock me-2 planner-icon"></i>Estimated Time
                              <i class="fas fa-chevron-down ms-auto toggle-icon"></i>
                            </h6>
                          </button>
                          <div class="collapse show" id="timeCollapse">
                            <div class="planner-content p-3 rounded-3 d-flex align-items-center" style="background: rgba(25, 135, 84, 0.05); border-left: 4px solid #198754;">
                              <i class="fas fa-hourglass-half text-success me-3 fs-4"></i>
                              <span class="fs-5 fw-bold"><%= task.planner.estimatedTime %></span>
                            </div>
                          </div>
                        </div>
                      <% } %>
                      <% if (task.planner.motivation) { %>
                        <div class="planner-section mb-3">
                          <button class="btn btn-link planner-toggle p-0 text-decoration-none w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#motivationCollapse" aria-expanded="true">
                            <h6 class="text-primary mb-2 d-flex align-items-center">
                              <i class="fas fa-fire me-2 planner-icon"></i>Motivation
                              <i class="fas fa-chevron-down ms-auto toggle-icon"></i>
                            </h6>
                          </button>
                          <div class="collapse show" id="motivationCollapse">
                            <div class="planner-content p-3 rounded-3" style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(255, 193, 7, 0.05) 100%); border-left: 4px solid #dc3545;">
                              <div class="d-flex align-items-start">
                                <i class="fas fa-fire-alt text-danger me-3 fs-4 mt-1"></i>
                                <div>
                                  <p class="mb-0 fw-bold text-danger"><%= task.planner.motivation %></p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% } %>

              <!-- Milestones Section -->
              <div class="card shadow mt-4" style="border-radius: 15px; border: none; background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);">
                <div class="card-body p-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 style="color: #2c3e50; font-weight: 600;">
                      <i class="fas fa-flag text-primary me-2"></i>Milestones
                    </h4>
                    <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#addMilestoneForm" aria-expanded="false">
                      <i class="fas fa-plus me-1"></i>Add Milestone
                    </button>
                  </div>

                  <!-- Add Milestone Form -->
                  <div class="collapse mb-3" id="addMilestoneForm">
                    <div class="card border-primary" style="border-radius: 10px;">
                      <div class="card-body p-3">
                        <form action="/task/<%= task._id %>/milestone" method="POST">
                          <div class="row g-3">
                            <div class="col-md-8">
                              <input type="text" class="form-control" name="title" placeholder="Milestone title" required style="border-radius: 8px;">
                            </div>
                            <div class="col-md-4">
                              <input type="date" class="form-control" name="dueDate" required style="border-radius: 8px;">
                            </div>
                          </div>
                          <div class="mt-3">
                            <button type="submit" class="btn btn-primary btn-sm me-2" style="border-radius: 20px;">
                              <i class="fas fa-plus me-1"></i>Add
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#addMilestoneForm" style="border-radius: 20px;">
                              Cancel
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  </div>

                  <% if (task.milestones && task.milestones.length > 0) { %>
                    <div class="milestones-list">
                      <% task.milestones.forEach((milestone, index) => { %>
                        <div class="milestone-item d-flex justify-content-between align-items-center p-3 mb-2 rounded-3" style="background: <%= milestone.completed ? 'rgba(25, 135, 84, 0.1)' : 'rgba(102, 126, 234, 0.05)' %>; border: 1px solid <%= milestone.completed ? 'rgba(25, 135, 84, 0.2)' : 'rgba(102, 126, 234, 0.1)' %>;">
                          <div class="d-flex align-items-center">
                            <div class="milestone-icon me-3">
                              <% if (milestone.completed) { %>
                                <i class="fas fa-check-circle text-success fs-4"></i>
                              <% } else { %>
                                <i class="fas fa-circle text-muted fs-4"></i>
                              <% } %>
                            </div>
                            <div>
                              <h6 class="mb-1 <%= milestone.completed ? 'text-decoration-line-through text-muted' : '' %>"><%= milestone.title %></h6>
                              <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i><%= new Date(milestone.dueDate).toLocaleDateString() %>
                              </small>
                            </div>
                          </div>
                          <div class="milestone-actions d-flex gap-2">
                            <form action="/task/<%= task._id %>/milestone/<%= index %>/toggle" method="POST" class="d-inline">
                              <button type="submit" class="btn btn-sm <%= milestone.completed ? 'btn-outline-success' : 'btn-outline-primary' %>" style="border-radius: 15px;">
                                <i class="fas <%= milestone.completed ? 'fa-undo' : 'fa-check' %>"></i>
                              </button>
                            </form>
                            <button type="button" class="btn btn-info btn-sm" style="border-radius: 15px;" onclick="openMilestoneSidebar('<%= index %>')">
                              <i class="fas fa-sticky-note"></i> Notes
                            </button>
                          </div>
                        </div>
                      <% }); %>
                    </div>
                    <!-- Milestone Sidebar -->
                    <div id="milestoneSidebar" class="milestone-sidebar" style="display:none; position:fixed; top:0; right:0; width:400px; max-width:100vw; height:100vh; background:#fff; box-shadow:-4px 0 32px rgba(102,126,234,0.15); z-index:9999; transition:right 0.3s;">
                      <div style="padding:32px 28px; border-bottom:1px solid #e9ecef; display:flex; justify-content:space-between; align-items:center;">
                        <h4 id="milestoneSidebarTitle" style="margin:0; font-weight:700; color:#2c3e50;"><i class="fas fa-sticky-note me-2"></i>Milestone Notes</h4>
                        <button type="button" class="btn btn-light btn-sm" onclick="closeMilestoneSidebar()" style="border-radius:50%;"><i class="fas fa-times"></i></button>
                      </div>
                      <div id="milestoneNotePad" style="padding:28px; height:calc(100vh - 110px); display:flex; flex-direction:column;">
                        <div id="milestoneNoteDisplay" style="flex:1; overflow-y:auto; background:#f8f9ff; border-radius:12px; border:1.5px solid #e9ecef; padding:18px; font-size:1.08rem; color:#2c3e50; margin-bottom:18px; white-space:pre-wrap;"></div>
                        <form id="milestoneNoteForm" method="POST" style="display:none; flex:1; flex-direction:column;">
                          <textarea id="milestoneNoteTextarea" name="note" rows="12" class="form-control mb-3" style="border-radius:12px; font-size:1.08rem; background:#f8f9ff; border:1.5px solid #e9ecef; padding:18px; height:100%; resize:vertical;"></textarea>
                          <button type="submit" class="btn btn-success px-4 py-2 align-self-end" style="border-radius:20px; font-weight:600;">Save Notes</button>
                        </form>
                        <button id="milestoneNoteEditBtn" type="button" class="btn btn-outline-primary px-4 py-2 align-self-end" style="border-radius:20px; font-weight:600;">Edit</button>
                      </div>
                    </div>
                    <script>
                      let currentMilestoneIndex = null;
                      let currentMilestoneNote = '';
                      function openMilestoneSidebar(index) {
                        currentMilestoneIndex = index;
                        document.getElementById('milestoneSidebar').style.display = 'block';
                        document.getElementById('milestoneSidebarTitle').innerText = 'Milestone Notes: ' + document.querySelectorAll('.milestone-item h6')[index].innerText;
                        document.getElementById('milestoneNoteForm').action = '/task/<%= task._id %>/milestone/' + index + '/note';
                        // Fetch note via AJAX
                        fetch(`/task/<%= task._id %>/milestone/${index}/note`)
                          .then(res => res.json())
                          .then(data => {
                            currentMilestoneNote = data.note || '';
                            document.getElementById('milestoneNoteDisplay').innerText = currentMilestoneNote || 'No notes yet.';
                            document.getElementById('milestoneNoteTextarea').value = currentMilestoneNote;
                            document.getElementById('milestoneNoteDisplay').style.display = 'block';
                            document.getElementById('milestoneNoteForm').style.display = 'none';
                            document.getElementById('milestoneNoteEditBtn').style.display = 'inline-block';
                          });
                      }
                      function closeMilestoneSidebar() {
                        document.getElementById('milestoneSidebar').style.display = 'none';
                        document.getElementById('milestoneNoteTextarea').value = '';
                        document.getElementById('milestoneNoteDisplay').innerText = '';
                      }
                      document.getElementById('milestoneNoteEditBtn').onclick = function() {
                        document.getElementById('milestoneNoteDisplay').style.display = 'none';
                        document.getElementById('milestoneNoteForm').style.display = 'flex';
                        document.getElementById('milestoneNoteEditBtn').style.display = 'none';
                        document.getElementById('milestoneNoteTextarea').focus();
                      };
                      document.getElementById('milestoneNoteForm').onsubmit = function(e) {
                        e.preventDefault();
                        const note = document.getElementById('milestoneNoteTextarea').value;
                        fetch(this.action, {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                          body: 'note=' + encodeURIComponent(note)
                        })
                        .then(res => res.ok ? res : Promise.reject(res))
                        .then(() => {
                          document.getElementById('milestoneNoteDisplay').innerText = note;
                          document.getElementById('milestoneNoteDisplay').style.display = 'block';
                          document.getElementById('milestoneNoteForm').style.display = 'none';
                          document.getElementById('milestoneNoteEditBtn').style.display = 'inline-block';
                        });
                      };
                    </script>
                    <style>
                      .milestone-sidebar {
                        animation: slideInSidebar 0.3s ease;
                      }
                      @keyframes slideInSidebar {
                        from { right:-400px; opacity:0; }
                        to { right:0; opacity:1; }
                      }
                    </style>
                  <% } else { %>
                    <div class="text-center py-4">
                      <i class="fas fa-flag fa-2x text-muted mb-2"></i>
                      <p class="text-muted mb-0">No milestones yet. Add your first milestone to break down this task!</p>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Sidebar -->
        <div class="col-lg-4">
          <div class="card shadow" style="border-radius: 15px; border: none; background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);">
            <div class="card-body p-4">
              <h5 class="card-title mb-4" style="color: #2c3e50; font-weight: 600;">
                <i class="fas fa-cogs text-primary me-2"></i>Actions
              </h5>

              <div class="d-grid gap-3">
                <a href="/task" class="btn btn-outline-primary d-flex align-items-center justify-content-center" style="border-radius: 25px; padding: 12px; transition: all 0.3s ease;">
                  <i class="fas fa-arrow-left me-2"></i>Back to Tasks
                </a>
                <a href="/task/<%= task._id %>/edit" class="btn btn-warning d-flex align-items-center justify-content-center" style="border-radius: 25px; padding: 12px; transition: all 0.3s ease;">
                  <i class="fas fa-edit me-2"></i>Edit Task
                </a>
                <form action="/task/<%= task._id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to delete this task?')">
                  <button type="submit" class="btn btn-danger d-flex align-items-center justify-content-center w-100" style="border-radius: 25px; padding: 12px; transition: all 0.3s ease;">
                    <i class="fas fa-trash me-2"></i>Delete Task
                  </button>
                </form>
              </div>

              <hr class="my-4">

              <div class="task-meta">
                <small class="text-muted d-block mb-2">
                  <i class="fas fa-calendar-plus me-1"></i>Created: <%= new Date(task.createdAt).toLocaleDateString() %>
                </small>
                <small class="text-muted d-block">
                  <i class="fas fa-clock me-1"></i>Last updated: <%= new Date(task.updatedAt || task.createdAt).toLocaleDateString() %>
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.info-card:hover {
  transform: translateY(-2px);
  transition: transform 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
}

.milestone-item:hover {
  transform: translateX(5px);
  transition: transform 0.3s ease;
}

.btn:hover {
  transform: translateY(-2px);
  transition: transform 0.3s ease;
}

.text-purple {
  color: #764ba2 !important;
}

.display-4 {
  font-size: 2.5rem;
}

/* Smart Planner Styles */
.planner-title {
  position: relative;
}

.planner-title::after {
  content: '';
  position: absolute;
  bottom: -5px;
  left: 0;
  width: 50px;
  height: 3px;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 2px;
}

.planner-card {
  transition: all 0.3s ease;
}

.planner-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 35px rgba(102, 126, 234, 0.2) !important;
}

.planner-toggle {
  transition: all 0.3s ease;
  border-radius: 10px;
  padding: 8px 12px;
}

.planner-toggle:hover {
  background-color: rgba(102, 126, 234, 0.05);
  transform: translateX(5px);
}

.planner-icon {
  transition: transform 0.3s ease;
}

.planner-toggle:hover .planner-icon {
  transform: scale(1.1);
}

.toggle-icon {
  transition: transform 0.3s ease;
}

.collapsed .toggle-icon {
  transform: rotate(-90deg);
}

.planner-content {
  transition: all 0.3s ease;
  animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.planner-section {
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 1rem;
}

.planner-section:hover .planner-content {
  transform: translateX(5px);
}

@media (max-width: 768px) {
  .display-4 {
    font-size: 2rem;
  }

  .info-card {
    margin-bottom: 1rem;
  }

  .planner-content {
    padding: 1rem !important;
  }

  .planner-toggle {
    font-size: 0.9rem;
  }
}
</style>
