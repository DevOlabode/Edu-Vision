<% layout('layout/boilerplate.ejs') %>
<% title = 'Change Password' %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      <!-- Change Password Header -->
      <div class="change-password-header text-center mb-5">
        <div style="background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); border-radius: 25px; padding: 50px 30px; color: white; box-shadow: 0 20px 40px rgba(253, 121, 168, 0.3); position: relative; overflow: hidden;">
          <div style="position: absolute; top: -20px; right: -20px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
          <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%;"></div>
          <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.9;">
            <i class="fas fa-lock"></i>
          </div>
          <h1 style="font-weight: 700; font-size: 2.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 10px;">
            Change Password
          </h1>
          <p style="opacity: 0.9; margin-bottom: 0; font-size: 1.1rem;">
            Keep your account secure with a strong password
          </p>
        </div>
      </div>

      <!-- Change Password Form -->
      <div class="change-password-card" style="background: linear-gradient(145deg, #ffffff 0%, #fff8f8 100%); border-radius: 20px; box-shadow: 0 10px 30px rgba(253, 121, 168, 0.15); overflow: hidden; border: 1px solid rgba(253, 121, 168, 0.1);">
        <div class="change-password-card-body" style="padding: 40px;">
          <form action="/change-password" method="POST" class="needs-validation" novalidate id="changePasswordForm">

            <!-- Current Password -->
            <div class="mb-4">
              <label for="currentPassword" class="form-label" style="font-weight: 600; color: #2c3e50; font-size: 1.1rem; margin-bottom: 12px;">
                <i class="fas fa-key me-2" style="color: #fd79a8;"></i>Current Password
              </label>
              <div class="input-group">
                <input type="password" class="form-control form-control-lg" id="currentPassword" name="currentPassword" required
                       style="border-radius: 15px 0 0 15px; border: 2px solid #e9ecef; border-right: none; padding: 14px 20px; font-size: 1rem; transition: all 0.3s ease; background: rgba(253, 121, 168, 0.02);"
                       placeholder="Enter your current password">
                <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword"
                        style="border-radius: 0 15px 15px 0; border: 2px solid #e9ecef; border-left: none; background: rgba(253, 121, 168, 0.02);">
                  <i class="fas fa-eye" id="currentPasswordIcon"></i>
                </button>
              </div>
              <div class="invalid-feedback" style="margin-top: 8px;">
                Please enter your current password.
              </div>
            </div>

            <!-- New Password -->
            <div class="mb-4">
              <label for="newPassword" class="form-label" style="font-weight: 600; color: #2c3e50; font-size: 1.1rem; margin-bottom: 12px;">
                <i class="fas fa-lock me-2" style="color: #fd79a8;"></i>New Password
              </label>
              <div class="input-group">
                <input type="password" class="form-control form-control-lg" id="newPassword" name="newPassword" required
                       style="border-radius: 15px 0 0 15px; border: 2px solid #e9ecef; border-right: none; padding: 14px 20px; font-size: 1rem; transition: all 0.3s ease; background: rgba(253, 121, 168, 0.02);"
                       placeholder="Enter a new password" minlength="8">
                <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword"
                        style="border-radius: 0 15px 15px 0; border: 2px solid #e9ecef; border-left: none; background: rgba(253, 121, 168, 0.02);">
                  <i class="fas fa-eye" id="newPasswordIcon"></i>
                </button>
              </div>
              <div class="invalid-feedback" style="margin-top: 8px;">
                Please enter a new password (minimum 8 characters).
              </div>
              <small style="color: #6c757d; font-size: 0.9rem; margin-top: 8px; display: block;">
                <i class="fas fa-info-circle me-1"></i>Password must be at least 8 characters long
              </small>
            </div>

            <!-- Confirm New Password -->
            <div class="mb-4">
              <label for="confirmPassword" class="form-label" style="font-weight: 600; color: #2c3e50; font-size: 1.1rem; margin-bottom: 12px;">
                <i class="fas fa-check-circle me-2" style="color: #fd79a8;"></i>Confirm New Password
              </label>
              <div class="input-group">
                <input type="password" class="form-control form-control-lg" id="confirmPassword" name="confirmPassword" required
                       style="border-radius: 15px 0 0 15px; border: 2px solid #e9ecef; border-right: none; padding: 14px 20px; font-size: 1rem; transition: all 0.3s ease; background: rgba(253, 121, 168, 0.02);"
                       placeholder="Confirm your new password">
                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword"
                        style="border-radius: 0 15px 15px 0; border: 2px solid #e9ecef; border-left: none; background: rgba(253, 121, 168, 0.02);">
                  <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                </button>
              </div>
              <div class="invalid-feedback" style="margin-top: 8px;">
                Please confirm your new password.
              </div>
            </div>

            <!-- Password Strength Indicator -->
            <div class="mb-4" id="passwordStrength" style="display: none;">
              <label class="form-label" style="font-weight: 600; color: #2c3e50; font-size: 1rem; margin-bottom: 8px;">
                Password Strength
              </label>
              <div class="progress" style="height: 8px; border-radius: 10px;">
                <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%; border-radius: 10px;"></div>
              </div>
              <small id="strengthText" style="color: #6c757d; font-size: 0.9rem; margin-top: 4px; display: block;"></small>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between mt-5">
              <a href="/profile" class="btn btn-outline-secondary btn-lg" style="border-radius: 25px; font-weight: 600; padding: 14px 30px; border: 2px solid #6c757d; transition: all 0.3s ease;">
                <i class="fas fa-arrow-left me-2"></i>Cancel
              </a>
              <button type="submit" class="btn btn-primary btn-lg" style="border-radius: 25px; font-weight: 700; font-size: 1.1rem; padding: 14px 30px; box-shadow: 0 8px 25px rgba(253, 121, 168, 0.3); transition: all 0.3s ease; background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%); border: none;">
                <i class="fas fa-save me-2"></i>Change Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Password visibility toggles
document.getElementById('toggleCurrentPassword').addEventListener('click', function() {
  const input = document.getElementById('currentPassword');
  const icon = document.getElementById('currentPasswordIcon');
  togglePasswordVisibility(input, icon);
});

document.getElementById('toggleNewPassword').addEventListener('click', function() {
  const input = document.getElementById('newPassword');
  const icon = document.getElementById('newPasswordIcon');
  togglePasswordVisibility(input, icon);
});

document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
  const input = document.getElementById('confirmPassword');
  const icon = document.getElementById('confirmPasswordIcon');
  togglePasswordVisibility(input, icon);
});

function togglePasswordVisibility(input, icon) {
  if (input.type === 'password') {
    input.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    input.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// Password strength checker
document.getElementById('newPassword').addEventListener('input', function() {
  const password = this.value;
  const strengthBar = document.getElementById('strengthBar');
  const strengthText = document.getElementById('strengthText');
  const strengthDiv = document.getElementById('passwordStrength');

  if (password.length > 0) {
    strengthDiv.style.display = 'block';
    const strength = calculatePasswordStrength(password);
    updateStrengthIndicator(strength, strengthBar, strengthText);
  } else {
    strengthDiv.style.display = 'none';
  }
});

function calculatePasswordStrength(password) {
  let strength = 0;
  if (password.length >= 8) strength += 25;
  if (/[a-z]/.test(password)) strength += 25;
  if (/[A-Z]/.test(password)) strength += 25;
  if (/[0-9]/.test(password)) strength += 15;
  if (/[^A-Za-z0-9]/.test(password)) strength += 10;
  return Math.min(strength, 100);
}

function updateStrengthIndicator(strength, bar, text) {
  bar.style.width = strength + '%';

  if (strength < 25) {
    bar.style.backgroundColor = '#dc3545';
    text.textContent = 'Very Weak';
    text.style.color = '#dc3545';
  } else if (strength < 50) {
    bar.style.backgroundColor = '#fd7e14';
    text.textContent = 'Weak';
    text.style.color = '#fd7e14';
  } else if (strength < 75) {
    bar.style.backgroundColor = '#ffc107';
    text.textContent = 'Fair';
    text.style.color = '#ffc107';
  } else if (strength < 100) {
    bar.style.backgroundColor = '#20c997';
    text.textContent = 'Good';
    text.style.color = '#20c997';
  } else {
    bar.style.backgroundColor = '#28a745';
    text.textContent = 'Strong';
    text.style.color = '#28a745';
  }
}

// Password confirmation validation
document.getElementById('confirmPassword').addEventListener('input', function() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = this.value;

  if (confirmPassword !== newPassword) {
    this.setCustomValidity('Passwords do not match');
  } else {
    this.setCustomValidity('');
  }
});

// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('changePasswordForm');

  form.addEventListener('submit', function(event) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (newPassword !== confirmPassword) {
      event.preventDefault();
      document.getElementById('confirmPassword').setCustomValidity('Passwords do not match');
      form.classList.add('was-validated');
      return;
    }

    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
  });

  // Enhanced focus effects
  const inputs = document.querySelectorAll('input');
  inputs.forEach(input => {
    input.addEventListener('focus', function() {
      this.style.borderColor = '#fd79a8';
      this.style.boxShadow = '0 0 0 0.2rem rgba(253, 121, 168, 0.25)';
      this.style.background = 'rgba(253, 121, 168, 0.05)';
    });

    input.addEventListener('blur', function() {
      this.style.borderColor = '#e9ecef';
      this.style.boxShadow = 'none';
      this.style.background = 'rgba(253, 121, 168, 0.02)';
    });
  });
});
</script>

<style>
.change-password-card input:focus {
  border-color: #fd79a8 !important;
  box-shadow: 0 0 0 0.2rem rgba(253, 121, 168, 0.25) !important;
  background: rgba(253, 121, 168, 0.05) !important;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(253, 121, 168, 0.4) !important;
}

.input-group .btn {
  border-color: #e9ecef !important;
}

.input-group .btn:hover {
  background-color: rgba(253, 121, 168, 0.1) !important;
  border-color: #fd79a8 !important;
}
</style>
